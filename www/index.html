<!DOCTYPE html>

<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="msapplication-tap-highlight" content="no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
        
		<!--<link rel="stylesheet" type="text/css" href="css/index.css" />-->
		<link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css">
		<link rel="stylesheet" href="css/style.css">
		<link rel="stylesheet" href="css/jqm-datebox.core.min.css">
		<!--<link rel="stylesheet" href="css/jquery.mobile.datepicker.theme.css">
		<script src="js/jquery.mobile.datepicker.js"></script>
		<script src="js/datepicker.js"></script>
		-->
		
		<script src="js/jquery.js"></script>
		<script src="js/jquery.mobile-1.4.5.min.js"></script>
		<script src="js/jqm-datebox.core.min.js"></script>
		<script src="js/jqm-datebox.mode.calbox.min.js"></script>
		<script src="js/jqm-datebox.i18n.js"></script>
		
		<script src="js/purl.js"></script><!--to parse urls and variables sent via url -->
		<script>
			/*$(document).on('pagebeforeshow', "#home",function(){
				$(document).on('click', "#search",function(){
					$.mobile.changePage('search-results.html',{dataUrl:"search-results.html", data:{'from':'1', 'to':'2', reloadPage:true, changeHash:true}});
				}); 
				
			}); */
			
			
			
			$(document).ready(function(){
			
				//Get the date/time of today
				nowTime = new Date();
				
				//Initialize datebox and set default date
				$('#date').datebox({
					mode: "calbox",
					afterToday: true, //Dates available only as from the date of today
					overrideDateFormat: "%d-%m-%Y",
					"useFocus": true //make the entire input to trigger the calendar, not jus the icon
				});
				$("#date").datebox('setTheDate', nowTime).trigger('datebox', {'method':'doset'});
			})
			
			//WHEN THE SEARCH BUTTON IS CLICKED
			//Catch the search form's submit
			$(document).on('click',"#search", function(){
				
				var link = "http://localhost/quickticket/mobile/search_schedule?departure_time=any";
				//var link = "http://dev.quickticket.co/mobile/search_schedule?&departure_time=any";
				var from = $("#town_from").val();
				var from_name = $("#town_from option:selected").html();
				var to = $("#town_to").val();
				var to_name = $("#town_to option:selected").html();
				var departure_date = $("#date").val();
			
				//check origin and destination
				if(from==to){
				 alert('Origin and destination can\'t be same.');
				 return;
				}else{
				
					//Send via ajax
					$.ajax({url: link,
						data: {
							from: from,
							to: to,
							departure_date: departure_date
						},
						dataType:'json',
						type:'get',
						async: true,
						beforeSend: function(){
							$.mobile.loading("show"); //show the ajax spinner
						},
						complete: function(){
							//$.mobile.loading("hide"); //hide the ajax spinner
						},
						success: function(data){ //for each search result, populate the list
							//if the result is an empty object, no dat was found
							if (jQuery.isEmptyObject(data))
							{	$.mobile.loading("hide"); //hide the ajax spinner
							   $('#search-results-list').append("<li class='ui-last-child'><a href='' class='ui-btn'><div>No schedules available at the moment. <br/>Please try again later.</div></a></li>");
							}else{
								$.each(data, function(index, element){
									$.mobile.loading("hide"); //hide the ajax spinner
									$('#search-results-list').append("<li class='ui-first-child ui-last-child'><a href='schedule-details.html?bus_seats="+element.bus_seats+"&ticket_price="+element.ticket_price+"&departure_time="+element.departure_time+"&parent_name="+element.parent_name+"&departure_date="+departure_date+"&from="+from+"&to="+to+"&from_name="+from_name+"&to_name="+to_name+"' id='schedule-details' class='ui-btn ui-btn-icon-right ui-icon-carat-r'><div>"+element.parent_name+"</div><div><span class='grey'>"+element.bus_seats+" seater </span> | "+element.departure_time+" </div><span class='ui-li-aside'><h2>"+element.ticket_price+" frs</h2></span></a></li>");
								});
							}
							//put the origin and destination as title of the page
							$('#route').html(from_name+' to '+to_name);
						},
						error: function(){ //If there's an error
							alert('Error: Can\'t connect. Verify your internet connection and try again.');
							$.mobile.loading("hide"); //hide the ajax spinner
							exit;
						}
					});
					
					
					//go to the search result page
					$.mobile.changePage('search-results.html',{
						dataUrl:"search-results.html", 
						data:{
							reloadPage:false, 
							changeHash:false}});
					}
			});
				
				
			
				
				//WHEN A PARTICULAR SCHEDULE IS SELECTED
				$(document).on('click',"#schedule-details", function(){
				
					//Get the full url of the link that was clicked and pass to the function to get the variables
					url = this.href;
					var bus_seats = getURLParameterByName('bus_seats',url);
					var ticket_price = getURLParameterByName('ticket_price',url);
					var departure_time = getURLParameterByName('departure_time',url);
					var parent_name = getURLParameterByName('parent_name',url);
					var departure_date = getURLParameterByName('departure_date',url);
					var from = getURLParameterByName('from',url);
					var to = getURLParameterByName('to',url);
					var from_name = getURLParameterByName('from_name',url);
					var to_name = getURLParameterByName('to_name',url);
					 
					//alert(bus_seats+ticket_price+departure_time+parent_name+departure_date+from+to+from_name+to_name);
					
					//before showing schedule-details page, fill it in with the details
					//doesn't work if you don't use onpagebeforeshow
					$(document).on('pagebeforeshow', "#schedule-details",function(){
						$('#town-from').html(from_name);		
						$('#town-to').html(to_name);
						$('#bus-seats').html(bus_seats+ " seater");		
						$('#ticket-price').html(ticket_price+" frs");		
						$('#departure-date').html(departure_date);		
						$('#departure-time').html(departure_time);		
						$('#parent-name').html(parent_name);	
					});
										
				});
				
			//WHEN THE TICKET INFORMATION IS SUBMITTTED
			//Catch the search form's submit
			$(document).on('click',"#add-purchase", function(){
				
				var link = "http://localhost/quickticket/mobile/add_purchase";
				//var link = "http://dev.quickticket.co/mobile/search_schedule?&departure_time=any";
				var name = $("#name").val();
				var idc = $("#idc").val();
				var phone = $("#phone").val();
				var email = $("#email").val();
			
				//check origin and destination
				if(!name){
				 alert('Provide your name, phone and ID card number.');
				 return;
				}else{
				
					//Send via ajax
					$.ajax({url: link,
						data: 
						{
							name: name,
							idc: idc,
							email: email,
							phone: phone
						},
						
						dataType:'json',
						type:'get',
						async: true,
						beforeSend: function(){
							$.mobile.loading("show"); //show the ajax spinner
							
						},
						complete: function(){
							//$.mobile.loading("hide"); //hide the ajax spinner
						},
						success: function(data){ 
						
						 alert('here');
						//for each search result, populate the list
							//if the result is an empty object, no dat was found
							if (jQuery.isEmptyObject(data))
							{	$.mobile.loading("hide"); //hide the ajax spinner
							   $('#search-results-list').append("<li class='ui-last-child'><a href='' class='ui-btn'><div>No schedules available at the moment. <br/>Please try again later.</div></a></li>");
							}else{
								$.each(data, function(index, element){
									$.mobile.loading("hide"); //hide the ajax spinner
									$('#search-results-list').append("<li class='ui-first-child ui-last-child'><a href='schedule-details.html?bus_seats="+element.bus_seats+"&ticket_price="+element.ticket_price+"&departure_time="+element.departure_time+"&parent_name="+element.parent_name+"&departure_date="+departure_date+"&from="+from+"&to="+to+"&from_name="+from_name+"&to_name="+to_name+"' id='schedule-details' class='ui-btn ui-btn-icon-right ui-icon-carat-r'><div>"+element.parent_name+"</div><div><span class='grey'>"+element.bus_seats+" seater </span> | "+element.departure_time+" </div><span class='ui-li-aside'><h2>"+element.ticket_price+" frs</h2></span></a></li>");
								});
							}
							//put the origin and destination as title of the page
							$('#route').html(from_name+' to '+to_name);
						},
						error: function(){ //If there's an error
						alert(this.url);
							alert('Error: Can\'t connect. Verify your internet connection and try again.');
							$.mobile.loading("hide"); //hide the ajax spinner
							exit;
						}
					});
					
					
					//go to the search result page
					$.mobile.changePage('search-results.html',{
						dataUrl:"search-results.html", 
						data:{
							reloadPage:false, 
							changeHash:false}});
					}
			});
				
				
				
				//THIS FUNCTION EXTRACTS URL PARAMETERS BY THEIR NAMES
				function getURLParameterByName(name,url) {
					name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
					var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
						//link in url
						//results = regex.exec(location.search);
						results = regex.exec(url);
					return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
				}
				
				
		</script>
		
		
        <title>QuickTicket | Inter-city bus tickets - Buy and reserve</title>
    </head>
    <body>
      
            
               
			   <div data-role="page" id="home">
					<div data-theme="a" data-role="header">
						
						<h1>
							Search buses
						</h1>
					</div>        
					<div role="main" class="ui-content">
						
						
						<form data-ajax="false">
						   
						    <label >From:</label>
						    <select name="town_from" id="town_from" style="background-color:white;">
						        <option value="1">Buea</option>
						        <option value="2">Bamenda</option>
						        <option value="3" selected="selected">Yaounde</option>
						        <option value="4">Douala</option>
						        <option value="5">Bafoussam</option>
						    </select>
						<br/>
						<label >To:</label>
						    <select name="town_to" id="town_to">
						        <option value="1">Buea</option>
						        <option value="2">Bamenda</option>
						        <option value="3">Yaounde</option>
						        <option value="4" selected="selected">Douala</option>
						        <option value="5">Bafoussam</option>
						    </select>
						<br/>
						<label >Choose date:</label>
						<br/>
						
						<div><input id="date" type="text"></div>
						<!--<input type="text" data-role="datebox" data-options='{"mode":"calbox"}'>-->
						<br/><br/>

						
						
						
						<a href="#" class="ui-btn" data-role='button' id="search">Search</a>
						<!--<a href="schedule-details.html" class="ui-btn" data-role='button' id="details">Details</a>-->
						   
						</form>
						
					</div>
					<div data-theme="d" class="footer" data-role="footer" data-position="fixed">
						<h1>QuickTicket &copy; 2015</h1>
					</div>        
				</div>
				
				
				
				
				
			
				
         
       
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
        <script type="text/javascript" src="js/search.js"></script>
        <script type="text/javascript">
            //app.initialize();
        </script>
    </body>
</html>
